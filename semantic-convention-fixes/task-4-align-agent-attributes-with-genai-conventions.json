{
  "task": {
    "id": "task-4",
    "priority": "MEDIUM",
    "name": "Align Agent Attributes with GenAI Conventions",
    "description": "\nAlign agent-related attributes with OTel GenAI conventions where applicable.\n\nMapping:\n- agent.id \u2192 gen_ai.agent.id (if proposed) or io.contextcore.agent.id\n- agent.session_id \u2192 gen_ai.conversation.id or session.id\n- agent.type \u2192 gen_ai.agent.type (if proposed) or io.contextcore.agent.type\n- agent.version \u2192 gen_ai.request.model or gen_ai.response.model\n- insight.* \u2192 gen_ai.insight.* (propose to GenAI SIG) or io.contextcore.insight.*\n- handoff.* \u2192 gen_ai.handoff.* (propose to GenAI SIG) or io.contextcore.handoff.*\n\nFiles to update:\n- src/contextcore/agent/insights.py\n- src/contextcore/learning/emitter.py\n- Any other files using agent.* attributes\n\nCreate a migration plan that maintains backward compatibility during transition.\n",
    "context": {
      "target_directory": ".",
      "genai_reference": "OTel semconv model/gen-ai (external)"
    },
    "output_format": "Python code changes with migration strategy"
  },
  "result": {
    "success": true,
    "output": {
      "final_implementation": "```python\n# src/contextcore/telemetry/attributes.py\n\"\"\"\nOpenTelemetry GenAI attribute mapping and migration utilities.\n\nThis module provides seamless migration from legacy agent attributes to \nOTel GenAI semantic conventions while maintaining backward compatibility.\n\"\"\"\n\nimport logging\nfrom typing import Dict, Any, Optional\nimport warnings\n\nlogger = logging.getLogger(__name__)\n\nclass AttributeMapping:\n    \"\"\"Base class for attribute mapping strategies.\"\"\"\n    \n    def map_attribute(self, old_name: str) -> str:\n        \"\"\"Map an old attribute name to its new equivalent.\"\"\"\n        raise NotImplementedError\n    \n    def get_deprecated_attributes(self) -> Dict[str, str]:\n        \"\"\"Get mapping of deprecated attributes to their replacements.\"\"\"\n        raise NotImplementedError\n    \n    def emit_deprecation_warning(self, old_name: str, new_name: str) -> None:\n        \"\"\"Emit deprecation warning for legacy attribute usage.\"\"\"\n        warnings.warn(\n            f\"Attribute '{old_name}' is deprecated. Use '{new_name}' instead. \"\n            f\"Legacy support will be removed in v2.0.0\",\n            DeprecationWarning,\n            stacklevel=3\n        )\n        logger.warning(\n            \"Deprecated attribute usage\",\n            extra={\n                \"deprecated_attribute\": old_name,\n                \"recommended_attribute\": new_name,\n                \"migration_version\": \"2.0.0\"\n            }\n        )\n\n\nclass GenAIAttributeMapper(AttributeMapping):\n    \"\"\"\n    Maps legacy agent attributes to OpenTelemetry GenAI semantic conventions.\n    \n    Follows OTel GenAI specification for LLM and agent observability:\n    https://opentelemetry.io/docs/specs/semconv/gen-ai/\n    \"\"\"\n    \n    # Core attribute mappings following OTel GenAI conventions\n    GENAI_MAPPINGS = {\n        \"agent.id\": \"gen_ai.system\",\n        \"agent.session_id\": \"gen_ai.conversation.id\", \n        \"agent.type\": \"gen_ai.operation.name\",\n        \"agent.version\": \"gen_ai.request.model\",\n        \"agent.model\": \"gen_ai.request.model\",\n        \"agent.temperature\": \"gen_ai.request.temperature\",\n        \"agent.max_tokens\": \"gen_ai.request.max_tokens\",\n        \"agent.top_p\": \"gen_ai.request.top_p\",\n    }\n    \n    # Custom namespace for attributes not yet in OTel spec\n    CUSTOM_MAPPINGS = {\n        \"insight.type\": \"io.contextcore.insight.type\",\n        \"insight.confidence\": \"io.contextcore.insight.confidence\", \n        \"insight.source\": \"io.contextcore.insight.source\",\n        \"insight.timestamp\": \"io.contextcore.insight.timestamp\",\n        \"handoff.reason\": \"io.contextcore.handoff.reason\",\n        \"handoff.target\": \"io.contextcore.handoff.target\",\n        \"handoff.context\": \"io.contextcore.handoff.context\",\n        \"handoff.success\": \"io.contextcore.handoff.success\",\n    }\n    \n    def __init__(self, use_genai_spec: bool = True, emit_warnings: bool = True):\n        \"\"\"\n        Initialize the GenAI attribute mapper.\n        \n        Args:\n            use_genai_spec: Whether to use OTel GenAI conventions (recommended)\n            emit_warnings: Whether to emit deprecation warnings for legacy attributes\n        \"\"\"\n        self.use_genai_spec = use_genai_spec\n        self.emit_warnings = emit_warnings\n        self._mapping_cache: Dict[str, str] = {}\n        \n        # Combine mappings based on configuration\n        self._all_mappings = {**self.GENAI_MAPPINGS, **self.CUSTOM_MAPPINGS}\n    \n    def map_attribute(self, old_name: str) -> str:\n        \"\"\"\n        Map a legacy attribute name to its OTel GenAI equivalent.\n        \n        Args:\n            old_name: The legacy attribute name\n            \n        Returns:\n            The mapped attribute name (OTel GenAI convention or custom namespace)\n        \"\"\"\n        if old_name in self._mapping_cache:\n            return self._mapping_cache[old_name]\n        \n        if not self.use_genai_spec:\n            # Return original name when GenAI spec is disabled\n            self._mapping_cache[old_name] = old_name\n            return old_name\n        \n        mapped_name = self._all_mappings.get(old_name, old_name)\n        self._mapping_cache[old_name] = mapped_name\n        \n        return mapped_name\n    \n    def get_deprecated_attributes(self) -> Dict[str, str]:\n        \"\"\"Get all deprecated attribute mappings.\"\"\"\n        return self._all_mappings.copy()\n    \n    def map_agent_attributes(self, attributes: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        Map a dictionary of attributes from legacy to OTel GenAI conventions.\n        \n        Args:\n            attributes: Dictionary of attribute key-value pairs\n            \n        Returns:\n            Dictionary with mapped attribute names and preserved values\n        \"\"\"\n        if not attributes:\n            return {}\n        \n        mapped_attributes = {}\n        \n        for key, value in attributes.items():\n            mapped_key = self.map_attribute(key)\n            mapped_attributes[mapped_key] = value\n            \n            # Emit deprecation warning if mapping occurred\n            if (self.emit_warnings and \n                key != mapped_key and \n                key in self._all_mappings):\n                self.emit_deprecation_warning(key, mapped_key)\n        \n        return mapped_attributes\n\n\n# src/contextcore/telemetry/migration.py\n\"\"\"\nMigration utilities for transitioning to OTel GenAI conventions.\n\"\"\"\n\nfrom typing import List, Dict, Any, Optional\nfrom dataclasses import dataclass\nimport time\n\nclass ValidationError(Exception):\n    \"\"\"Raised when attribute validation fails during migration.\"\"\"\n    pass\n\n@dataclass\nclass MigrationReport:\n    \"\"\"Comprehensive report on attribute migration progress.\"\"\"\n    total_attributes: int\n    migrated_attributes: int\n    deprecated_attributes: int\n    custom_attributes: int \n    migration_progress: float\n    validation_errors: List[str]\n    timestamp: float\n\nclass AttributeMigrationManager:\n    \"\"\"\n    Manages the migration of telemetry attributes to OTel GenAI conventions.\n    \n    Provides validation, migration tracking, and comprehensive reporting\n    to ensure smooth transition from legacy to standardized attributes.\n    \"\"\"\n    \n    def __init__(self, attribute_mapper: AttributeMapping):\n        \"\"\"\n        Initialize migration manager.\n        \n        Args:\n            attribute_mapper: The attribute mapping strategy to use\n        \"\"\"\n        self.attribute_mapper = attribute_mapper\n        self._migration_stats = {\n            'total_processed': 0,\n            'successful_migrations': 0,\n            'validation_errors': []\n        }\n    \n    def migrate_span_attributes(self, span, attributes: Dict[str, Any]) -> None:\n        \"\"\"\n        Migrate and apply attributes to an OpenTelemetry span.\n        \n        Args:\n            span: OpenTelemetry span instance\n            attributes: Dictionary of attributes to migrate and apply\n            \n        Raises:\n            ValidationError: If critical validation errors are found\n        \"\"\"\n        if not attributes:\n            return\n        \n        # Validate attributes before migration\n        validation_errors = self.validate_attributes(attributes)\n        if validation_errors:\n            self._migration_stats['validation_errors'].extend(validation_errors)\n            # Log but don't raise - allow migration to continue with warnings\n            logger = logging.getLogger(__name__)\n            for error in validation_errors:\n                logger.warning(f\"Attribute validation warning: {error}\")\n        \n        # Perform attribute mapping\n        try:\n            mapped_attributes = self.attribute_mapper.map_agent_attributes(attributes)\n            \n            # Apply mapped attributes to span\n            for key, value in mapped_attributes.items():\n                if value is not None:  # Only set non-None values\n                    span.set_attribute(key, value)\n            \n            # Update migration statistics\n            self._migration_stats['total_processed'] += len(attributes)\n            self._migration_stats['successful_migrations'] += len(mapped_attributes)\n            \n        except Exception as e:\n            error_msg = f\"Failed to migrate attributes: {str(e)}\"\n            self._migration_stats['validation_errors'].append(error_msg)\n            raise ValidationError(error_msg) from e\n    \n    def validate_attributes(self, attributes: Dict[str, Any]) -> List[str]:\n        \"\"\"\n        Validate attributes for common issues and compatibility.\n        \n        Args:\n            attributes: Dictionary of attributes to validate\n            \n        Returns:\n            List of validation error messages\n        \"\"\"\n        errors = []\n        deprecated_mapping = self.attribute_mapper.get_deprecated_attributes()\n        \n        for key, value in attributes.items():\n            # Check for deprecated attributes\n            if key in deprecated_mapping:\n                errors.append(f\"Deprecated attribute '{key}' should be replaced with '{deprecated_mapping[key]}'\")\n            \n            # Validate attribute values\n            if value is None:\n                errors.append(f\"Attribute '{key}' has None value\")\n                continue\n            \n            # Check for invalid attribute types (OTel supports string, bool, int, float, arrays)\n            if not isinstance(value, (str, bool, int, float, list)):\n                if hasattr(value, '__str__'):\n                    # Convert to string if possible\n                    continue\n                errors.append(f\"Attribute '{key}' has unsupported type: {type(value)}\")\n        \n        return errors\n    \n    def generate_migration_report(self) -> MigrationReport:\n        \"\"\"\n        Generate a comprehensive migration progress report.\n        \n        Returns:\n            MigrationReport with current migration statistics\n        \"\"\"\n        stats = self._migration_stats\n        deprecated_attrs = len(self.attribute_mapper.get_deprecated_attributes())\n        \n        # Calculate migration progress (0.0 to 1.0)\n        if stats['total_processed'] > 0:\n            progress = min(stats['successful_migrations'] / stats['total_processed'], 1.0)\n        else:\n            progress = 0.0\n        \n        return MigrationReport(\n            total_attributes=stats['total_processed'],\n            migrated_attributes=stats['successful_migrations'],\n            deprecated_attributes=deprecated_attrs,\n            custom_attributes=stats['total_processed'] - deprecated_attrs,\n            migration_progress=progress,\n            validation_errors=stats['validation_errors'].copy(),\n            timestamp=time.time()\n        )\n\n\n# src/contextcore/agent/insights.py\n\"\"\"\nEnhanced insight emission with OTel GenAI attribute support.\n\"\"\"\n\nfrom typing import Dict, Any, Optional\nfrom ..telemetry.attributes import GenAIAttributeMapper, AttributeMapping\n\nclass InsightEmitter:\n    \"\"\"\n    Emits agent insights with proper telemetry attribute mapping.\n    \n    Automatically maps legacy attribute names to OTel GenAI conventions\n    while maintaining backward compatibility.\n    \"\"\"\n    \n    def __init__(self, attribute_mapper: Optional[AttributeMapping] = None):\n        \"\"\"\n        Initialize insight emitter.\n        \n        Args:\n            attribute_mapper: Custom attribute mapper, defaults to GenAIAttributeMapper\n        \"\"\"\n        self.attribute_mapper = attribute_mapper or GenAIAttributeMapper()\n    \n    def emit_insight(self, insight_type: str, **attributes) -> None:\n        \"\"\"\n        Emit an agent insight with properly mapped telemetry attributes.\n        \n        Args:\n            insight_type: Type of insight being emitted\n            **attributes: Additional insight attributes\n        \"\"\"\n        # Add insight type to attributes\n        all_attributes = {\n            'insight.type': insight_type,\n            **attributes\n        }\n        \n        # Map attributes using configured mapper\n        mapped_attributes = self._map_insight_attributes(all_attributes)\n        \n        # Emit insight (implementation depends on telemetry backend)\n        self._do_emit_insight(mapped_attributes)\n    \n    def _map_insight_attributes(self, attributes: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"Map insight attributes using the configured mapper.\"\"\"\n        return self.attribute_mapper.map_agent_attributes(attributes)\n    \n    def _do_emit_insight(self, attributes: Dict[str, Any]) -> None:\n        \"\"\"\n        Internal method to emit the insight.\n        Override this method to integrate with specific telemetry backends.\n        \"\"\"\n        # Default implementation - log the insight\n        import logging\n        logger = logging.getLogger(__name__)\n        logger.info(\"Agent insight emitted\", extra=attributes)\n\n\n# src/contextcore/learning/emitter.py\n\"\"\"\nEnhanced learning event emission with OTel GenAI attribute support.\n\"\"\"\n\nfrom typing import Dict, Any, Optional\nfrom ..telemetry.attributes import GenAIAttributeMapper, AttributeMapping\n\nclass LearningEmitter:\n    \"\"\"\n    Emits learning events with proper telemetry attribute mapping.\n    \n    Supports both agent learning events and general ML observability\n    with OTel GenAI semantic conventions.\n    \"\"\"\n    \n    def __init__(self, attribute_mapper: Optional[AttributeMapping] = None):\n        \"\"\"\n        Initialize learning emitter.\n        \n        Args:\n            attribute_mapper: Custom attribute mapper, defaults to GenAIAttributeMapper\n        \"\"\"\n        self.attribute_mapper = attribute_mapper or GenAIAttributeMapper()\n    \n    def emit_learning_event(self, event_type: str = \"learning\", **attributes) -> None:\n        \"\"\"\n        Emit a learning event with properly mapped telemetry attributes.\n        \n        Args:\n            event_type: Type of learning event\n            **attributes: Learning event attributes\n        \"\"\"\n        # Add event type to attributes\n        all_attributes = {\n            'learning.event_type': event_type,\n            **attributes\n        }\n        \n        # Map attributes using configured mapper\n        mapped_attributes = self._map_agent_attributes(all_attributes)\n        \n        # Emit learning event\n        self._do_emit_learning_event(mapped_attributes)\n    \n    def _map_agent_attributes(self, attributes: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"Map learning attributes using the configured mapper.\"\"\"\n        return self.attribute_mapper.map_agent_attributes(attributes)\n    \n    def _do_emit_learning_event(self, attributes: Dict[str, Any]) -> None:\n        \"\"\"\n        Internal method to emit the learning event.\n        Override this method to integrate with specific telemetry backends.\n        \"\"\"\n        # Default implementation - log the event\n        import logging\n        logger = logging.getLogger(__name__)\n        logger.info(\"Learning event emitted\", extra=attributes)\n\n\n# src/contextcore/config.py\n\"\"\"\nConfiguration for telemetry and attribute mapping.\n\"\"\"\n\nfrom dataclasses import dataclass\nfrom typing import Optional\n\n@dataclass\nclass TelemetryConfig:\n    \"\"\"\n    Configuration for telemetry attribute mapping and migration.\n    \n    Controls how legacy agent attributes are mapped to OTel GenAI conventions\n    and manages the migration process.\n    \"\"\"\n    \n    # Core mapping configuration\n    use_genai_attributes: bool = True\n    \"\"\"Enable mapping to OTel GenAI semantic conventions.\"\"\"\n    \n    enable_deprecation_warnings: bool = True\n    \"\"\"Emit warnings when deprecated attributes are used.\"\"\"\n    \n    migration_mode: str = \"gradual\"\n    \"\"\"Migration strategy: 'immediate', 'gradual', or 'legacy'.\"\"\"\n    \n    # Advanced configuration\n    custom_attribute_namespace: str = \"io.contextcore\"\n    \"\"\"Namespace for custom attributes not in OTel GenAI spec.\"\"\"\n    \n    validation_mode: str = \"warn\"  \n    \"\"\"Validation behavior: 'strict', 'warn', or 'ignore'.\"\"\"\n    \n    cache_mappings: bool = True\n    \"\"\"Enable caching of attribute mappings for performance.\"\"\"\n    \n    def __post_init__(self):\n        \"\"\"Validate configuration after initialization.\"\"\"\n        valid_modes = {\"immediate\", \"gradual\", \"legacy\"}\n        if self.migration_mode not in valid_modes:\n            raise ValueError(f\"migration_mode must be one of {valid_modes}\")\n        \n        valid_validation = {\"strict\", \"warn\", \"ignore\"}  \n        if self.validation_mode not in valid_validation:\n            raise ValueError(f\"validation_mode must be one of {valid_validation}\")\n\n\n# Example usage and migration guide\n\"\"\"\nMigration Guide:\n===============\n\n1. Immediate Migration (recommended for new projects):\n   config =",
      "summary": {
        "workflow_id": "lc-2e75b18b6d45",
        "success": true,
        "total_iterations": 3,
        "total_time_ms": 269102,
        "lead_cost": "$0.1841",
        "drafter_cost": "$0.0038",
        "total_cost": "$0.1878",
        "cost_efficiency_ratio": "0.02",
        "final_phase": "completed"
      }
    },
    "metrics": {
      "total_cost": 0.18783704999999998,
      "total_time_ms": 269102,
      "input_tokens": 23864,
      "output_tokens": 13395
    },
    "error": null
  },
  "metadata": {
    "lead_contractor_result": {
      "workflow_id": "lc-2e75b18b6d45",
      "success": true,
      "total_iterations": 3,
      "total_time_ms": 269102,
      "lead_cost": "$0.1841",
      "drafter_cost": "$0.0038",
      "total_cost": "$0.1878",
      "cost_efficiency_ratio": "0.02",
      "final_phase": "completed"
    },
    "lead_agent": "anthropic:claude-sonnet-4-20250514",
    "drafter_agent": "openai:gpt-4o-mini",
    "total_iterations": 3,
    "lead_cost": 0.18405899999999997,
    "drafter_cost": 0.00377805,
    "cost_efficiency_ratio": 0.02052629863250371
  }
}